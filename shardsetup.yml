---
- name: Mongo shard setup
  hosts: "{{ target }}"
  gather_facts: yes
  strategy: "{{ set_strategy | default(lookup('config', 'DEFAULT_STRATEGY')) }}"
  vars:
    env: pet
    replica_set: sh1_pet
    mongodb1: ae1rsbxlmdb001
    mongodb2: ae1rsbxlmdb002
    mongodb3: ae1rsbxlmdb003
    shard1port: 37040
    shard2port: 37041
    shard3port: 37042

- name: Ensure replicaset rs0 exists
  community.mongodb.mongodb_replicaset:
    login_host: localhost
    login_user: admin
    login_password: admin
    replica_set: "{{ replica_set }}"
    members:
        - "{{ mongodb1 }}:{{ shard1port }}"
        - "{{ mongodb2 }}:{{ shard2port }}"
        - "{{ mongodb3 }}:{{ shard3port }}"
    when: groups.mongod.index(inventory_hostname) == 0

- name: Add a replicaset shard 
  community.mongodb.mongodb_shard:
    login_user: admin
    login_password: admin
    shard: "{{ replica_set }}/{{ mongodb1 }}:{{ shard1port }}"
    state: present

- name: Add a replicaset shard 
  community.mongodb.mongodb_shard:
    login_user: admin
    login_password: admin
    shard: "{{ replica_set }}/{{ mongodb2 }}:{{ shard2port }}"
    state: present

- name: Add a replicaset shard 
  community.mongodb.mongodb_shard:
    login_user: admin
    login_password: admin
    shard: "{{ replica_set }}/{{ mongodb3 }}:{{ shard3port }}"
    state: present
