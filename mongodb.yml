---
- name: Configure MongoDB
  hosts: "{{ target }}"
  tasks:
    - name: set_fact
      import_tasks: roles/setup_mongodb/tasks/set_fact.yml
      tags: always

    - name: config_filesystem
      include_role:
        name: config_filesystem
      when: "config_filesystem == 'yes'"
      tags: [ partitions, lvm, opt, data, test ]

    - name: base install
      include_role:
        name: base_install_mongodb
      when: "base_install == 'yes'"
      tags: [ uninstall, base, dbtools, make_file, add_certs, logrotate, hugepages, mms_agent, test ]

    - name: install ops manager
      include_role: 
        name: ops_manager
      when: "ansible_hostname in [ops_server_1, ops_server_2, ops_server_3]"
      tags: [ tuned, appdb, no_sec_mongod, repset, users, ops_manager, mongod, test ]

    - name: setup config servers
      include_role:
        name: config_servers
      when: "ansible_hostname in [configsvr_rsa, configsvr_rsb, configsvr_rsc]"
      tags: [ mongo_service, no_sec_servers, mongos, setup_users, create_role, ldap_interval, start_mongos, servers, initiate_clusters, keepalive, add_shards, mms_agent, test ]

    - name: setup shard servers
      include_role:
        name: shard_servers
      when: "ansible_hostname in [shard1a, shard1b, shard1c, shard2a, shard2b, shard2c, shard3a, shard3b, shard3c]"
      tags: [ mongo_service, no_sec_servers, setup_users, create_role, ldap_interval, servers, initiate_clusters, keepalive, add_shards, mms_agent, test ]

    - name: setup single repset servers
      include_role:
        name: single_repset_servers
      when: "ansible_hostname in [rs_1, rs_2, rs_3]"
      tags: [ mongo_service, no_sec_servers, setup_users, create_role, ldap_interval, servers, initiate_clusters, keepalive, mms_agent, test ]

