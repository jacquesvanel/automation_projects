---
- name: make config file directory /etc/mongo/{{ env }}/
  ansible.builtin.file:
    path: /etc/mongo/{{ env }}/
    state: directory
    mode: '2770'
    owner: mongod
    group: opr-db-admin

- name: make log file directory /var/log/mongodb/{{ env }}/
  ansible.builtin.file:
    path: /var/log/mongodb/{{ env }}/
    state: directory
    mode: '2755'
    owner: mongod
    group: opr-db-admin

- name: make pid file directory /var/run/mongodb/{{ env }}/
  ansible.builtin.file:
    path: /var/run/mongodb/{{ env }}/
    state: directory
    mode: '2750'
    owner: mongod
    group: opr-db-admin

### section for keyfile###
- name: make keyfile directory /data/{{ env }}/
  ansible.builtin.file:
    path: /data/{{ env }}/
    state: directory
    mode: '2770'
    owner: mongod
    group: opr-db-admin

- name: get key file from artifactory and place it in /data/{{ env }}/keyfile.pem
  ansible.builtin.get_url:
    url: "{{ keyfile }}"
    dest: /data/{{ env }}/keyfile.pem
    owner: mongod
    group: opr-db-admin
    mode: '0600'

- name: make cert directory /var/lib/mongo/cert/
  ansible.builtin.file:
    path: /var/lib/mongo/cert/
    state: directory
    mode: '2770'
    owner: mongod
    group: opr-db-admin
    
- name: get keycert file from artifactory and place it in /var/lib/mongo/cert/KeyWCert.pem
  ansible.builtin.get_url:
    url: "{{ keycert }}"
    dest: /var/lib/mongo/cert/KeyWCert.pem

    #- name: make dbpath file directory
    #ansible.builtin.file:
    #path: /data/{{ env }}/{{ shard[0] }}/{{ repset }}
    #state: directory
    #mode: '2770'
    #owner: mongod
    #group: opr-db-admin

###section for logrotate###
- name: layout template for logrotate on the server and place it in /etc/logrotate.d/mongo
  template:
    src:  logrotate.conf.j2
    dest: "/etc/logrotate.d/mongo"
    owner: root
    group: root
    mode: '0640'

###section for hugepages###
- name: layout template for added hugepages_service on the server and place it in /etc/systemd/system/mongodb-hugepage-fix.service
  template:
    src: hugepages_service.j2
    dest: "/etc/systemd/system/mongodb-hugepage-fix.service"
    owner: root
    group: root
    mode: '0640'

- name: start and enable hugepages_service
  systemd:
    name: mongodb-hugepage-fix
    state: restarted
    enabled: yes
    daemon_reload: yes
