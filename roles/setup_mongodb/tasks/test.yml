---
#Configure MongoDB config servers
- set_fact:
      db_servers:
        - name: rs_a
          path: /data/{{ env }}/config/rs_a
          config_file: rs_a.cfg
          config_var: configsvr_rsa
        - name: rs_b
          path: /data/{{ env }}/config/rs_b
          config_file: rs_b.cfg
          config_var: configsvr_rsb
        - name: rs_c
          path: /data/{{ env }}/config/rs_c
          config_file: rs_c.cfg
          config_var: configsvr_rsc
- debug:
    var: item.config_var
  loop: "{{ db_servers.keys() | list }}"
  #when: item.config_var is defined and ansible_hostname == item.config_var

- name: make dbpath file directory for config server
  file:
    path: "{{ item.path }}"
    state: directory
    mode: '2775'
    owner: "{{ owner }}"
    group: "{{ group }}"
  with_dict: "{{ db_servers }}"
  when: item.config_var is defined and ansible_hostname == item.config_var
  ignore_errors: yes

- name: layout template for config server config file
  template:
    src: no_sec_mongod.conf.j2
    dest: "/etc/mongo/{{ env }}/{{ item.config_file }}"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: '0644'
    force: yes
  with_dict: "{{ db_servers }}"
  when: item.config_var is defined and ansible_hostname == item.config_var
  ignore_errors: yes

#block for mongod_config service files
- block:
  - name: layout template for added mongod_config.service on the server
    template:
      src: mongod_config.service.j2
      dest: "/usr/lib/systemd/system/mongod_config.service"
      owner: "{{ owner }}"
      group: "{{ group }}"
      mode: '0640'
      force: yes

  - name: start mongod_config
    systemd:
      name: mongod_config
      state: restarted
      enabled: yes
      daemon_reload: yes
  when: >
          configsvr_rsa is defined and ansible_hostname == configsvr_rsa or
          configsvr_rsb is defined and ansible_hostname == configsvr_rsb or
          configsvr_rsc is defined and ansible_hostname == configsvr_rsc
  ignore_errors: yes
