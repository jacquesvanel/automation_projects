---
- name: make file directory 
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
    owner: mongod
    group: opr-db-admin
  loop:
        # directory for config files #
    - { path: '/etc/mongo/{{ env }}/', mode: '2770' }
        # directory for log files #
    - { path: '/var/log/mongodb/{{ env }}/', mode: '2755' }
        # directory for pid files #
    - { path: '/var/run/mongodb/{{ env }}/', mode: '2750' }
        # directory for data paths #
    - { path: '/data/{{ env }}/', mode: '2770' }
        # directory for certs #
    - { path: '/var/lib/mongodb/cert/', mode: '2770' }
        # directory for js scripts #
    - { path: '/etc/mongo/{{ env }}/scripts/', mode: '2770' }

- name: Get certs and place them in designated folders
  get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
    owner: mongod
    group: opr-db-admin
    mode: '0600'
  loop:
        # placing keyfile cert #
    - { url: '{{ keyfile }}', dest: '/data/{{ env }}/keyfile.pem' }
        # placing keywcert cert #
    - { url: '{{ keycert }}', dest: '/var/lib/mongodb/cert/KeyWCert.pem' }
        # placing ieproot cert #
    - { url: '{{ ieproot }}', dest: '/var/lib/mongodb/cert/iep_root_intermediate.pem' }
        # placing ldap.conf #
    - { url: '{{ ldap }}', dest: '/var/lib/mongodb/cert/ldap.conf' }
        # placing CA cert #
    - { url: '{{ cacert }}', dest: '/var/lib/mongodb/cert/CA_Root_Inter.pem' }

- name: layout templates 
  template:
    src:  "{{ item.template }}"
    dest: "{{ item.tempdest }}"
    owner: mongod
    group: opr-db-admin
    mode: '0640'
    force: yes
  loop:
        # placing logrotate script #
    - { template: 'logrotate.conf.j2', tempdest: '/etc/logrotate.d/mongo' }
        # placing hugepages.service file #
    - { template: 'hugepages_service.j2', tempdest: '/etc/systemd/system/mongodb-hugepage-fix.service' }
        # placing mongo.service file #
    - { template: 'mongo.service.j2', tempdest: '/etc/systemd/system/mongo.service' }

- name: start hugepagesfix
  systemd:
    name: mongodb-hugepage-fix
    state: restarted
    enabled: yes
    daemon_reload: yes
