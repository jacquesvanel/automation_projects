---
- block:
  - name: [create_role.yml] make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: "{{ owner }}"
      group: "{{ group }}"
    loop: "{{ db_servers }}"
    loop_control:
      label: "{{ item.name }}"

  - name: [create_role.yml] layout role template for the server
    template:
      src:  createrole.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/createrole.js"
      owner: "{{ owner }}"
      group: "{{ group }}"
      mode: '0644'
      force: yes
    loop: "{{ db_servers }}"
    loop_control:
      label: "{{ item.name }}"

  - name: [create_role.yml] set up role on config server
    shell: mongo {{ ansible_fqdn }}:{{ item.port }}/admin /etc/mongo/{{ env }}/scripts/createrole.js
    register: role_result
    loop: "{{ db_servers }}"
    loop_control:
      label: "{{ item.name }}"
  
  - name: [create_role.yml] show role result
    debug:
      var: role_result.stdout_lines
    loop: "{{ db_servers }}"
    loop_control:
      label: "{{ item.name }}"
  when: >
        ansible_hostname == {{ item.name }} and item.name == 'configsvr_rsa' or
        ansible_hostname == {{ item.name }} and item.name == 'shard1a' or
        ansible_hostname == {{ item.name }} and item.name == 'shard2a' or
        ansible_hostname == {{ item.name }} and item.name == 'shard3a' or
        ansible_hostname == {{ item.name }} and item.name == 'rs_1'
  ignore_errors: yes
