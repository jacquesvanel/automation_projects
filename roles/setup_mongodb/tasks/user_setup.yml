---
- block:
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin

  - name: layout template for /etc/mongo/{{ env }}/scripts/user_setup.js the config server
    template:
      src:  user_setup.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/user_setup.js"
      owner: mongod
      group: opr-db-admin
      mode: '0644'
      force: yes

  - name: set up users
    shell: mongo {{ configsvr_rsa }}.opr.afsiep.net:37018 /etc/mongo/{{ env }}/scripts/user_setup.js
    register: shell_result
    
  - debug:
      var: shell_result.stdout_lines
   when: (configsvr_rsa is defined) and (ansible_hostname == configsvr_rsa)

- block:
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin

  - name: layout template for /etc/mongo/{{ env }}/scripts/user_setup.js the config server
    template:
      src:  user_setup.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/user_setup.js"
      owner: mongod
      group: opr-db-admin
      mode: '0644'
      force: yes

  - name: set up users
    shell: mongo {{ shard1a }}.opr.afsiep.net:37040 /etc/mongo/{{ env }}/scripts/user_setup.js
    register: shell_result

  - debug:
      var: shell_result.stdout_lines
   when: (shard1a is defined) and (ansible_hostname == shard1a)

- block:
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin

  - name: layout template for /etc/mongo/{{ env }}/scripts/user_setup.js the config server
    template:
      src:  user_setup.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/user_setup.js"
      owner: mongod
      group: opr-db-admin
      mode: '0644'
      force: yes

  - name: set up users
    shell: mongo {{ shard1a }}.opr.afsiep.net:37018 /etc/mongo/{{ env }}/scripts/user_setup.js
    register: shell_result

  - debug:
      var: shell_result.stdout_lines
   when: (shard1a is defined) and (ansible_hostname == shard1a)

- block:
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin

  - name: layout template for /etc/mongo/{{ env }}/scripts/user_setup.js the config server
    template:
      src:  user_setup.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/user_setup.js"
      owner: mongod
      group: opr-db-admin
      mode: '0644'
      force: yes

  - name: set up users
    shell: mongo {{ shard2a }}.opr.afsiep.net:47017 /etc/mongo/{{ env }}/scripts/user_setup.js
    register: shell_result

  - debug:
      var: shell_result.stdout_lines
   when: (shard2a is defined) and (ansible_hostname == shard2a)

- block:
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin

  - name: layout template for /etc/mongo/{{ env }}/scripts/user_setup.js the config server
    template:
      src:  user_setup.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/user_setup.js"
      owner: mongod
      group: opr-db-admin
      mode: '0644'
      force: yes

  - name: set up users
    shell: mongo {{ shard3a }}.opr.afsiep.net:57017 /etc/mongo/{{ env }}/scripts/user_setup.js
    register: shell_result

  - debug:
      var: shell_result.stdout_lines
   when: (shard3a is defined) and (ansible_hostname == shard3a)
