---
- block:
  - name: set up users on config server
    shell: mongo {{ configsvr_rsa }}.opr.afsiep.net:/{{ db_servers | selectattr('name', 'equalto', 'configsvr_rsa') | map(attribute='port') }}admin /etc/mongo/{{ env }}/scripts/user_setup.js
    register: config_result

  - name: show config shell result
    debug:
      var: config_result.stdout_lines
  when: (configsvr_rsa is defined) and (ansible_hostname == configsvr_rsa)
  ignore_errors: yes

- block:
  - name: set up users on shard1a
    shell: mongo {{ shard1a }}.opr.afsiep.net:/{{ db_servers | selectattr('name', 'equalto', 'shard1a') | map(attribute='port') }}admin /etc/mongo/{{ env }}/scripts/user_setup.js
    register: shard1_result

  - name: show shard1 shell result
    debug:
      var: shard1_result.stdout_lines
  when: (shard1a is defined) and (ansible_hostname == shard1a)
  ignore_errors: yes
- block:
  - name: set up users on shard2a
    shell: mongo {{ shard2a }}.opr.afsiep.net:{{ db_servers | selectattr('name', 'equalto', 'shard2a') | map(attribute='port') }}/admin /etc/mongo/{{ env }}/scripts/user_setup.js
    register: shard2_result

  - name: show shard2a shell result
    debug:
      var: shard2_result.stdout_lines
  when: (shard2a is defined) and (ansible_hostname == shard2a)
  ignore_errors: yes

- block:
  - name: set up users on shard3a
    shell: mongo {{ shard3a }}.opr.afsiep.net:{{ db_servers | selectattr('name', 'equalto', 'shard3a') | map(attribute='port') }}/admin /etc/mongo/{{ env }}/scripts/user_setup.js
    register: shard3_result

  - name: show shard3 shell result
    debug:
      var: shard3_result.stdout_lines
  when: (shard3a is defined) and (ansible_hostname == shard3a)
  ignore_errors: yes

- block:
  - name: set up users on rs_1
    shell: mongo {{ rs_1 }}.opr.afsiep.net:{{ db_servers | selectattr('name', 'equalto', 'rs_1') | map(attribute='port') }}/admin /etc/mongo/{{ env }}/scripts/user_setup.js
    register: rs_1_result

  - name: show rs_1 shell result
    debug:
      var: rs_1_result.stdout_lines
  when: (rs_1 is defined) and (ansible_hostname == rs_1)
  ignore_errors: yes
