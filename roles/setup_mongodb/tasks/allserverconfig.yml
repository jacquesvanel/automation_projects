---
- name: make config file directory /etc/mongo/{{ env }}/
  file:
    path: /etc/mongo/{{ env }}/
    state: directory
    mode: '2770'
    owner: mongod
    group: opr-db-admin

- name: make log file directory /var/log/mongodb/{{ env }}/
  file:
    path: /var/log/mongodb/{{ env }}/
    state: directory
    mode: '2755'
    owner: mongod
    group: opr-db-admin

- name: make pid file directory /var/run/mongodb/{{ env }}/
  file:
    path: /var/run/mongodb/{{ env }}/
    state: directory
    mode: '2750'
    owner: mongod
    group: opr-db-admin

### section for keyfile###
- name: make keyfile directory /data/{{ env }}/
  file:
    path: /data/{{ env }}/
    state: directory
    mode: '2770'
    owner: mongod
    group: opr-db-admin

- name: get key file from artifactory and place it in /data/{{ env }}/keyfile.pem
  get_url:
    url: "{{ keyfile }}"
    dest: /data/{{ env }}/keyfile.pem
    owner: mongod
    group: opr-db-admin
    mode: '0600'

- name: make cert directory /var/lib/mongo/cert/
  file:
    path: /var/lib/mongodb/cert/
    state: directory
    mode: '2770'
    owner: mongod
    group: opr-db-admin

- name: get keycert file from artifactory and place it in /var/lib/mongo/cert/KeyWCert.pem
  get_url:
    url: "{{ keycert }}"
    dest: /var/lib/mongodb/cert/KeyWCert.pem
    owner: mongod
    group: opr-db-admin
    mode: '0600'

###section for logrotate###
- name: layout template for logrotate on the server and place it in /etc/logrotate.d/mongo
  template:
    src:  logrotate.conf.j2
    dest: "/etc/logrotate.d/mongo"
    owner: mongod
    group: opr-db-admin
    mode: '0640'
    force: yes

###section for hugepages###
- name: layout template for added hugepages_service on the server and place it in /etc/systemd/system/mongodb-hugepage-fix.service
  template:
    src: hugepages_service.j2
    dest: "/etc/systemd/system/mongodb-hugepage-fix.service"
    owner: root
    group: root
    mode: '0640'
    force: yes

- name: start hugepagesfix
  systemd:
    name: mongodb-hugepage-fix
    state: restarted
    enabled: yes
    daemon_reload: yes

- name: make directory for /etc/mongo/{{ env }}/scripts/
  file:
    dest: /etc/mongo/{{ env }}/scripts/
    state: directory
    owner: mongod
    group: opr-db-admin

- name: layout template for /etc/mongo/{{ env }}/scripts/shutdown.js. 
  template:
    src:  shutdown.js.j2
    dest: "/etc/mongo/{{ env }}/scripts/shutdown.js"
    owner: mongod
    group: opr-db-admin
    mode: '0644'
    force: yes    
