---
#- name: insert restart line
#  blockinfile:
#    path: "{{ item }}"
#    insertbefore: 'Type=forking'
#    block: |
#      Restart=on-failure
#      RestartSec=10s 
#  loop:
#    - /usr/lib/systemd/system/mongod_shard1.service
#    - /usr/lib/systemd/system/mongod_shard2.service
#    - /usr/lib/systemd/system/mongod_shard3.service

- name: find config files on server
  find:
    paths: "/etc/mongod/sbx/"
    patterns: "*.cfg"
    recurse: yes
  register: cfgs

  #- name: replace security line in config file
  #  replace:
  #    path: "{{ item }}"
  #    regexp: '#security'
  #    replace: 'security'
  #  with_items: "{{cfgs.files | map(attribute='path')| list }}"

- name: remove block for config file
  blockinfile:
    path: "{{ item }}"
    marker: "{mark}"
    marker_begin: "'{"
    marker_end: "}'"
    state: absent
    block: |
               match : "(.+)",
               ldapQuery: "ou=IEP,DC=opr,DC=afsiep,DC=net??sub?(userPrincipalName={0})"
            
  with_items: "{{cfgs.files | map(attribute='path')| list }}"

- name: insert block for config file
  blockinfile:
    path: "{{ item }}"
    insertafter: 'userToDNMapping:'
    marker_begin: "'["
    marker_end: "]'"
    block: |
            {
               match : "(.+)",
               ldapQuery: "ou=IRS,DC=opr,DC=afsiep,DC=net??sub?(userPrincipalName={0})"
            },
            {
               match : "(.+)",
               ldapQuery: "ou=IEP,DC=opr,DC=afsiep,DC=net??sub?(userPrincipalName={0})"
            }
  with_items: "{{cfgs.files | map(attribute='path')| list }}"
