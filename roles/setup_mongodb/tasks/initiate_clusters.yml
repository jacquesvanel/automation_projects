---
# tasks file for initiate_mongo
- block:
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin

  - name: layout template for /etc/mongo/{{ env }}/scripts/initiate.shard1.js the shard1 server
    template:
      src:  initiate.shard1.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/initiate.shard1.js"
      owner: root
      group: root
      mode: '0644'
      force: yes

  - name: initiate shard replica set
    shell: mongo {{ shard1a }}.opr.afsiep.net:37040 /etc/mongo/{{ env }}/scripts/initiate.shard1.js
    register: shell_result
    delegate_to: "{{ shard1a }}"

  - debug:
      var: shell_result.stdout_lines
  when: shard1a is defined and ansible_hostname == shard1a

- block:
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin

  - name: layout template for /etc/mongo/{{ env }}/scripts/initiate.shard2.js the shard2 server
    template:
      src:  initiate.shard2.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/initiate.shard2.js"
      owner: root
      group: root
      mode: '0644'
      force: yes

  - name: initiate shard replica set
    shell: mongo {{ shard2a }}.opr.afsiep.net:47017 /etc/mongo/{{ env }}/scripts/initiate.shard2.js
    register: shell_result
    delegate_to: "{{ shard2a }}"

  - debug:
      var: shell_result.stdout_lines
  when: shard2a is defined and ansible_hostname == shard2a

- block: 
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin

  - name: layout template for /etc/mongo/{{ env }}/scripts/initiate.shard3.js the shard3 server
    template:
      src:  initiate.shard3.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/initiate.shard3.js"
      owner: root
      group: root
      mode: '0644'
      force: yes

  - name: initiate shard replica set
    shell: mongo {{ shard3a }}.opr.afsiep.net:57017 /etc/mongo/{{ env }}/scripts/initiate.shard3.js
    register: shell_result
    delegate_to: "{{ shard3a }}"

  - debug:
      var: shell_result.stdout_lines  
  when: shard3a is defined and ansible_hostname == shard3a

- block:
  - name: make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: mongod
      group: opr-db-admin
    
  - name: layout template for /etc/mongo/{{ env }}/scripts/initiate.config.js the config server
    template:
      src:  initiate.config.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/initiate.config.js"
      owner: root
      group: root
      mode: '0644'
      force: yes

  - name: initiate shard replica set
    shell: mongo {{ config1 }}.opr.afsiep.net:57040 /etc/mongo/{{ env }}/scripts/initiate.config.js
    register: shell_result
    delegate_to: "{{ config1 }}"
  
  - debug:
      var: shell_result.stdout_lines
  when: config1 is defined and ansible_hostname == config1
