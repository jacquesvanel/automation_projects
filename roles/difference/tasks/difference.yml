---
#CHECK THE ENVIRONMENT
- name: get env
  shell: cat /etc/serverinfo.conf | grep Environment | sed 's/Environment=//g' | tr [:upper:] [:lower:]
  register: envi
- name: show env variable
  debug:
    msg: "{{ envi.stdout }}"    



#CHECK WHAT TYPE OF MONGODB HOST FOR SBX ENVIRONMENT       
- name: check type of host (SBX)
  shell:
    cmd: cat /etc/mongo/sbx/{{ item }} | grep -i sharding
  loop: 
    - rs_a.cfg
    - rs_b.cfg
    - rs_c.cfg
  register: replicatset0
  when: envi.stdout == "sbx"
  ignore_errors: yes




#CHECK THE NAME OF THE CONFIF FILE, IN DSIT ENVIRONMENT    
- name: Checking config file name(DSIT - rs_a.cfg)
  shell:
    cmd: ls /etc/mongo/dsit_defunct_managed_by_ops_now | grep -i rs_a.cfg
  ignore_errors: yes
  when:  envi.stdout == "dsit"
  register: config_file_rs_a
 
- name: Checking config file name(DSIT - rs_b.cfg)
  shell:
    cmd: ls /etc/mongo/dsit_defunct_managed_by_ops_now | grep -i rs_b.cfg
  ignore_errors: yes
  when:  envi.stdout == "dsit"
  register: config_file_rs_b

- name: Checking config file name(DSIT - rs_c.cfg)
  shell:
    cmd: ls /etc/mongo/dsit_defunct_managed_by_ops_now | grep -i rs_c.cfg
  ignore_errors: yes
  when:  envi.stdout == "dsit"
  register: config_file_rs_c    




#CHECING THE TYPE OF MONGODB IN DSIT    
- name: Check type of host (for DSIT envi)
  shell:
    cmd: " cat /etc/mongo/dsit_defunct_managed_by_ops_now/rs_a.cfg | grep -i 'clusterRole: configsvr' "
  register: config_dsita    
  when: 
    - envi.stdout == "dsit" 
    - "'rs_a.cfg' in config_file_rs_a.stdout"
  ignore_errors: yes

- name: Check type of host (for DSIT envi)
  shell:
    cmd: " cat /etc/mongo/dsit_defunct_managed_by_ops_now/rs_b.cfg | grep -i 'clusterRole: configsvr' "
  register: config_dsitb
  when:
    - envi.stdout == "dsit" 
    - "'rs_b.cfg' in config_file_rs_b.stdout"
  ignore_errors: yes    

- name: Check type of host (for DSIT envi)
  shell:
    cmd: " cat /etc/mongo/dsit_defunct_managed_by_ops_now/rs_c.cfg | grep -i 'clusterRole: configsvr' "
  register: config_dsitc
  when:
    - envi.stdout == "dsit"
    - "'rs_c.cfg' in config_file_rs_c.stdout"
  ignore_errors: yes

- name: showing output of "config_dsit"
  debug:
    msg: "{{config_dsita.stdout}}"
  when:
    - envi.stdout == "dsit"
    - "'rs_a.cfg' in config_file_rs_a.stdout"

- name: showing output of "config_dsit"
  debug:
    msg: "{{config_dsitb.stdout}}"
  when:
    - envi.stdout == "dsit"
    - "'rs_b.cfg' in config_file_rs_b.stdout"

- name: showing output of "config_dsit"
  debug:
    msg: "{{config_dsitc.stdout}}"
  when:
    - envi.stdout == "dsit"
    - "'rs_c.cfg' in config_file_rs_c.stdout"


- name: Type of host (for DSIT envi)
  debug:
    msg: "{{ ansible_hostname }} is a CONFIG SERVER"
  when:
    - "'rs_a.cfg' in config_dsita.stdout" or "'rs_b.cfg' in config_dsitb.stdout" or "'rs_c.cfg' in config_dsitc.stdout"
    - envi.stdout == "dsit"


- name: Check type of host (for DEV)
  shell:
    cmd: " cat /etc/mongo/dev_defunct_managed_by_ops_now/{{ item }} | grep -i clusterRole: configsvr "
  loop:
    - rs_a.cfg
    - rs_b.cfg
    - rs_c.cfg
  register: config_dev
  when: envi.stdout == "dev"
  ignore_errors: yes

- name: Type of host (for DSIT envi)
  debug:
    msg: "{{ ansible_hostname }} is a CONFIG SERVER"
  when: 
    - config_dev.stdout | search('clusterRole: configsvr') 
    - envi.stdout == "dev"

- name: type of host (SBX)
  debug:
    msg: "{{ ansible_hostname }} is a REPLICATSET"
  when:
    - replicatset.stdout | search('sharding') 
    - envi.stdout == "sbx"  
