- name: Check storage usage
  hosts: "{{ target }} "

  tasks:
    - name: Get disk usage info
      shell: df -h
      register: disk_usage

    - name: Display disk usage percentage
      debug:
        msg: "{{ item.mount }} is at {{ item.percent }}% usage"
      loop: "{{ disk_usage.stdout_lines[1:] }}"

    - name: Fail if any mount is over 85%
      fail:
        msg: "Disk usage on {{ item.mount }} is over 85%"
      loop: "{{ disk_usage.stdout_lines[1:] }}"
      when: item.percent|int > 85

