---
- name: (setup_users.yml) make directory for /etc/mongo/{{ env }}/scripts/
  file:
    dest: /etc/mongo/{{ env }}/scripts/
    state: directory
    owner: "{{ owner }}"
    group: "{{ group }}"
  loop: "{{ db_servers }}"
  loop_control:
    label: "{{ item.name }}"
  when:  ansible_hostname == {{ item.name }} and item.name == 'rs_1'

- name: (setup_users.yml) layout user template for the server
  template:
    src:  user_setup.js.j2
    dest: "/etc/mongo/{{ env }}/scripts/user_setup_{{ item.name }}.js"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: '0644'
    force: yes
  loop: "{{ db_servers }}"
  loop_control:
    label: "{{ item.name }}"
  when:  ansible_hostname == {{ item.name }} and item.name == 'rs_1'

- name: (setup_users.yml) set up users on config server
  shell: mongo {{ ansible_fqdn }}:{{ item.port }}/admin /etc/mongo/{{ env }}/scripts/user_setup_{{ item.name }}.js
  register: user_result
  with_items: "{{ db_servers }}"
  loop_control:
    label: "{{ item.name }}"
  when:  ansible_hostname == {{ item.name }} and item.name == 'rs_1'
  ignore_errors: yes

- name: (setup_users.yml) show user result
  debug:
    var: user_result 
    #when:  ansible_hostname == {{ item.name }} and item.name == 'rs_1'
    #  with_items: "{{ db_servers }}"
  ignore_errors: yes

- name: Create MongoDB user
  mongodb_user:
    database: test
    name: test_user
    password: secret
    roles: readWrite

