---
- name:   Run shell to check the mongo services present
  shell:
    cmd: ps -ef | grep /var/lib/mongodb-mms-automation/mongodb-linux-x86_64-5.0.13-ent/bin/mongod | awk -F " " '{print $10}' | awk 'NR<=3' | awk -F  "/" '{print $4}'
  register: processes

- name: Show output of shell cmd
  debug:
    msg: "{{ processes.stdout_lines }}"

- name: Check if "pre_mongo_process" file exist 
  stat:
    path: /tmp/Mongo_processes/pre_mongo_services_status{{ ansible_date_time.date }}
  register: pre_file

- name: Check if "post_mongo_process" file exist 
  stat:
    path: /tmp/Mongo_processes/post_mongo_services_status_{{ ansible_date_time.date }}
  register: post_file

- name: Send output of running processes/services pre patching to "pre_mongo_process_{{ ansible_date_time.date }}"
  copy:
    content: |
            Running Mongo processes/services on {{ ansible_hostname }} before patching were:
            {{ processes.stdout }}
    dest: /tmp/Mongo_processes/pre_mongo_services_status_{{ ansible_date_time.date }}
  when: not pre_file.stat.exists

- name: Send output of running processes/services post patching to "post_mongo_process{{ ansible_date_time.date }}"
  copy:
    content: |
            Running Mongo processes/services on {{ ansible_hostname }} After patching on {{ ansible_date_time.date }} were:
            {{ processes.stdout }}
    dest: /tmp/Mongo_processes/post_mongo_services_status_{{ ansible_date_time.date }}
  when: pre_file.stat.exists 

- name: Generate diff
    shell: diff "/tmp/Mongo_processes/pre_mongo_services_status_{{ ansible_date_time.date }}" "/tmp/Mongo_processes/post_mongo_services_status_{{ ansible_date_time.date }}" 
  register: processes_diff
  ignore_errors: yes

- debug:
    msg: "{{ processes_diff.stdout_lines }}"                   

- name: Fail module for processes
  fail:
    msg: |
         "Mongodb files are different from eachother"
           "{{ processes_diff.stdout_lines }}"
    when: processes_diff.rc !=0
  when: pre_file.stat.exists and post_file.stat.exists 

# delete old files older than 90 days
- name: Find files older the 90 days old
  find:
    paths: /tmp/Mongo_processes
    patterns: *mongo_services_status*
    age: 90d
    recurse: yes
