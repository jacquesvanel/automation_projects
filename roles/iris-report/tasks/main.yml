---
# tasks file for iris-report
- set_fact:
     DT: "{{ ansible_date_time.date }}"
     #"/bin/sh date +%y%m%d" #date yymmdd
     DT1: "2023-01-23"
     #"/bin/sh date +%y%m%d | head -c 4 | tail -c 2" #numerical month
     DT2: "{{ ansible_date_time.day }}"
     #"/bin/sh date +%y%m%d | head -c 6 | tail -c 2" #numerical day
     DT3: "{{ lookup('pipe', 'date -d \"1 day ago\" +\"%Y-%m-%d\"') }}"
     #"{{ ansible_date_time.day |int - 01 }}"
     #"/bin/sh date -d '1 day ago' '+%y%m%d' | head -c 6 | tail -c 2"
###########################################################################
#Run mongo cmd that gets DB Names
- name: (shell_script.yml) run shell command
  shell: >
      mongo {{ target }}:37018/iris_prod_db
      -u {{ db_username }}
      -p {{ db_password }}
      --authenticationDatabase admin
      --eval 'db.TRANSMISSION.find({transmissionStatus:"REJECTED"}).count()'
      | tail -1
  register: shell1_result

- name: (shell_script.yml) show cmd output
  debug:
    msg: "{{ shell1_result.stdout }}"

###########################################################################
#run cmd that gets collection names
- name: (shell_script.yml) run 2nd command
  shell: >
        mongo {{ target }}:37018/iris_prod_db
        -u {{ db_username }}
        -p {{ db_password }}
        --authenticationDatabase admin
        --eval 'db.FORM.count()'
        | tail -1
  register: shell2_result

- name: (shell_script.yml) show cmd output
  debug:
    msg: "{{ shell2_result.stdout }}"

############################################################################
#run cmd that gets collection names
- name: (shell_script.yml) run 3rd command
  shell: >
        mongo {{ target }}:37018/iris_prod_db
        -u {{ db_username }}
        -p {{ db_password }}
        --authenticationDatabase admin
        --eval 'db.FORM.find({createdTs : { "$gte": ISODate("{{ DT3 }}T00:00:00.000Z"),
        $lt: ISODate("{{ DT }}T00:00:00.000Z") } }).count()'
        | tail -1
  register: shell3_result

- name: (shell_script.yml) show cmd output
  debug:
    msg: "{{ shell3_result.stdout }}"

############################################################################
#run cmd that gets collection names
- name: (shell_script.yml) run 4th command
  shell: >
        mongo {{ target }}:37018/iris_prod_db
        -u {{ db_username }}
        -p {{ db_password }}
        --authenticationDatabase admin
        --eval 'db.FORM.find({createdTs : { "$gte": ISODate("{{ DT1 }}T00:00:00.000Z"),
        $lt: ISODate("{{ DT }}T00:00:00.000Z") } }).count()'
        | tail -1
  register: shell4_result

- name: (shell_script.yml) show cmd output
  debug:
    msg: "{{ shell4_result.stdout }}"

############################################################################
- debug:
    msg: |-
     "Hi Prasad,"
          
     "Below are the output for todays run {{ DT }}"
        
     "**********************************************************************"
     "*TODAYS `date '+%A, %m-%d-%Y'` IRIS PROD FORM AND TRANSMISSION DATA COUNT*"
     "**********************************************************************"
     
     "{transmissionStatus:'REJECTED'}"
     "TRANSMISSION Coll. Data Count REJECTED is: {{ shell1_result.stdout.split('\n') }}"
     "======================================================================"
     
     "db.FORM.count()"
     "FORM Coll. Total Count of Data Count is: {{ shell2_result.stdout.split('\n') }}"
     "======================================================================"
     
     "{createdTs:{ $gte: ISODate({{ DT3 }}), $lt: ISODate({{ DT }})}}"
     "FORM Coll. Todays Count Of PROCESSING Data is: {{ shell3_result.stdout.split('\n') }}"
     "======================================================================"
     
     "{createdTs:{ $gte: ISODate({{ DT1 }}), $lt: ISODate({{ DT }})}}"
     "FORM Coll. PROCESSING Data Count From Jan 23, 2023 is: {{ shell4_result.stdout.split('\n') }}"
