---
# tasks file for initiate_mongo
- block:
  - name: (initiate_clusters.yml) make directory for /etc/mongo/{{ env }}/scripts/
    file:
      dest: /etc/mongo/{{ env }}/scripts/
      state: directory
      owner: "{{ owner }}"
      group: "{{ group }}"
    with_items: "{{ db_servers }}"
    loop_control:
      label: "{{ item.name }}"

  - name: (initiate_clusters.yml) layout initiate.js template on the server
    template:
      src:  initiate.js.j2
      dest: "/etc/mongo/{{ env }}/scripts/initiate_{{ item.name }}.js"
      owner: root
      group: root
      mode: '0644'
      force: yes
    with_items: "{{ db_servers }}"
    loop_control:
      label: "{{ item.name }}"

  - name: (initiate_clusters.yml) set up initiate on  server
    shell: mongo {{ ansible_fqdn }}:{{ item.port }}/admin /etc/mongo/{{ env }}/scripts/initiate_{{ item.name }}.js -u amkanda -p Qwerty#12345px
    register: initiate_result
    with_items: "{{ db_servers }}"
    loop_control:
      label: "{{ item.name }}"

  - name: (initiate_clusters.yml) show result
    debug:
      msg: "{{ initiate_result.stdout }}"
  when: >
          ansible_hostname == {{ item.name }} and item.name == 'shard1a' or
          ansible_hostname == {{ item.name }} and item.name == 'shard2a' or
          ansible_hostname == {{ item.name }} and item.name == 'shard3a' 
  ignore_errors: yes

