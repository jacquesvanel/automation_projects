---
#creates new lvm partition
#- debug:
#    msg: "{{ item.key }}"
#  with_dict: "{{ ansible_devices }}"
#  register: device
#  when: item.key.startswith('nvme') and item.value.partitions == {}
  
- name: Create partitions
  parted:
    device: "{{ device }}"
    number: "{{ partition }}"
    flags: [ lvm ]
    state: present
  register: part_create
  #  with_items: "{{ partition_data }}"

- name: get vgs
  debug:
    msg: "{{ item.key }}"
  with_dict: "{{ ansible_lvm.vgs }}"
  register: vg_name

#creates new pvs and extends existing vg to newly created partiton
- name: Create physical volume
  lvg:
    vg: "{{ vg_name.stdout }}"
    pvs: "{{ device }}p1,/dev/nvme0n1p2"
  when: part_create.changed
  register: pv_create
  ignore_errors: yes
