---
#creates new lvm partition
- set_fact:
    device_name: "{{ item.key }}"
  with_dict: "{{ ansible_devices }}"    
  when: item.key.startswith('nvme') and item.value.partitions == {}

- debug:
    var:  device_name
  
- name: Create partitions
  parted:
    device: "/dev/{{ device_name }}"
    number: 1
    flags: [ lvm ]
    state: present
  register: part_create

- debug:
    msg: "{{ ansible_lvm }}"

    #- set_fact:
    #    vgs_name: "{{ item.value.vg }}"
    #  with_dict: "{{ ansible_lvm.pvs }}"

- set_fact:
    vgs_name: "{{ item.key }}"
  with_dict: "{{ ansible_lvm.vgs }}"

- name: get vgs
  debug:
    var: vgs_name

- debug:
    var: ansible_lvm.pvs[vgs_name]

#creates new pvs and extends existing vg to newly created partiton
- name: Create physical volume
  lvg:
    vg: "{{ vgs_name }}"
    pvs: "/dev/{{ device }}p1,/dev/nvme0n1p2"
  when: part_create.changed
  register: pv_create
  ignore_errors: yes
