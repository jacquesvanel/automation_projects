---
- name: find
  find:
    paths:
      - "/usr/lib/systemd/system/"
      - "/etc/systemd/system/"
    patterns: "mongo*.service"
    excludes: 'mongodb-hugepage-fix.service'
    recurse: yes
  register: service

- name: checking mongo config service
  systemd:
    name: "{{ item }}"
  register: status
  with_items: "{{ service.files | map(attribute='path')| map('regex_replace','\\/usr\\/lib\\/systemd\\/system\\/','')| map('regex_replace','\\/etc\\/systemd\\/system\\/','') | list }}"

- name: status of all services
  debug:
    msg: "The status of {{ item.status.Names }} on {{ ansible_hostname }} is {{ item.status.ActiveState }}"
  with_items: "{{ status.results }}"
  loop_control:
    label: 'status'

#Getting a report of all the logs and their storage
#- name: Check disk usage
# shell: df -h | awk '{ print $5, $6 }'
# register: disk_usage

    #- name: Check disk usage threshold
    #debug:
    #var: disk_usage.stdout_lines
    #- name: Gather disk info from guests
    #  Target_disk_info:
    #    hostname: "{{ target }}"
    #    name: "{{ item }}"
    #  register: disk_info
    #  with_items:
    #  - "{{ target }}"

    #- name: Get disk info
    #  set_fact:
    #    disks_info: "{{ disk_info.results | list}}"

    #- name: Show servers with disk space more than 80 %
    #  assert:
    #    that:
    #      - 'disk_info._disks_info["0"].capacity_in_% <= 80'
        #- 'disk_info.disks_info["0"].capacity_in_% >= 0'
        #    fail_msg: "{{ item }} Disk space is higher must be below 80"

#fail message for disk space

- name: fail module
  fail:
    msg: "The status of {{ item.status.Names }} on {{ ansible_hostname }} is {{ item.status.ActiveState }}"
  when:  item.status.ActiveState == 'failed' or item.status.ActiveState == 'inactive'
  loop: "{{ status.results }}"
  loop_control:
    label: 'status'

