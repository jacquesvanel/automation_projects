---
#Getting a report of all the logs and their storage
- name: Check disk usage
  shell: df -h | awk '{ print $5 }' | sort -bgr | sed 's/%//g' | head -1
         #df -h | awk '{ print $5, $6 }'
  register: disk_usage

- debug:
    msg: "{{ disk_usage }}"

- set_fact:
    percent: "{{ disk_usage.stdout }}"

- debug:
    var: percent

- debug:
    msg: |
        Mount: {{ item.mount }}
        Device: {{ item.device }}
        Fstype: {{ item.fstype }}
        Disk Available: {{ disk_available }}GB
        Disk Used: {{ disk_usage }}GB
        Disk Total: {{ disk_total }}GB
        Percent Used: {{ disk_percent }}%
        {{item.mount}} is using {{ disk_percent }}% of allocated space
  with_items: "{{ ansible_mounts | list }}"

- name: Fail system state check if / has less than 90% space available
  fail:
    msg:
      - "partition size check FAILED! Please clear free space on {{ item.mount }} partition to less than 90% full"
  with_items: "{{ ansible_mounts | list }}"
  when:  disk_percent |int >= 50 
