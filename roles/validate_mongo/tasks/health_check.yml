---
- block:
  - name: get health of repset
    shell: "mongosh {{ ansible_fqdn }}:{{ port }}/admin -u {{ svc_ansible_automation }} -p {{ svc_ansible_automation_password }} --eval 'db.adminCommand( { replSetGetStatus: 1 } ).members' | less | grep 'stateStr:\\|health:\\|name:'"
    register: health
    #when: not secondary.stdout == 'true'

  - debug:
      msg: "{{ health.stdout.split('\n') }}"

  - name: Check health and stateStr values
    fail:
      msg: "Health check failed"
    when: item.health == 0
    with_items: "{{ health.stdout }}"
  when: secondary.stdout == 'false'