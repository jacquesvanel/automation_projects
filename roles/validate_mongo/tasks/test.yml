---
- name: check if server is primary or secondary
  shell: mongo "{{ ansible_hostname }}".opr.afsiep.net:37018/admin -u amkanda -p Qwerty#12345px  --eval 'rs.isMaster().secondary' | sort -r | head -1
  register: secondary

- debug:
    msg: "{{ secondary.stdout }}"

- block:
  - name: get health of repset
    shell: "mongosh {{ ansible_hostname }}.opr.afsiep.net:37018/admin -u amkanda -p Qwerty#12345px --eval 'db.adminCommand( { replSetGetStatus: 1 } ).members' | less | grep 'stateStr:\\|health:\\|name:'"
    register: health
    #when: not secondary.stdout == 'true'

  - debug:
      msg: "{{ health.stdout.split('\n') }}"

  #- name: Check health and stateStr values
  #  fail:
  #  msg: "Health check failed"
  #when: "'health: 0' in health.msg "
  - debug:
      msg: "{{ health.stdout | select('match', '(health):') | list }}"

  - name: Fail if MongoDB health check fails
    fail:
      msg: "MongoDB health check failed"
    when: "0 in health_output"
  vars:
    health_output:  "{{ health.stdout_lines | select('match', '(health):') | list }}"
  when: not secondary.stdout == 'true'

